<html>
    <head>
        <title>Enseak 2015</title>

        <link rel="stylesheet" href="dist/chartist.min.css">

        <style>
            html, body {
                background: #fff;
                font-family: sans-serif;
                height: 100%;
                margin: 0;
                overflow: hidden;
                padding: 0;
                width: 100%;
            }

            h1 {
                color: #222;
                margin: 0;
                padding: 10px 0;
                text-align: center;
            }

            #graph {
                height: calc(100% - 57px);
                margin: 0 auto;
                width: 95%;
            }
        </style>
    </head>

    <body>
        <h1>Graphique d'efficacité solaire/éolien - <span id="cityName"></span></h1>
        <div id="graph"></div>

        <script src="/socket.io/socket.io.js"></script>
        <script src="/dist/chartist.min.js"></script>
        <script>
            const cityName = location.hash.slice(1);
            document.getElementById('cityName').textContent = cityName;

            var sunData  = [];
            var windData = [];
            var $chart;
            var data = {
                labels: ['', 'Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
                         'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre']
            };

            fetch('/chart/' + cityName, {
                method: 'get'
            })
            .then(function (response) {
                return response.json();
            })
            .catch(function (err) {
                console.log(err.stack);
                // location.href = '/';
            })
            .then(function (response) {
                sunData = response.sun.filter((v, i) => i % 30 === 0);
                windData = response.wind.filter((v, i) => i % 30 === 0);

                data.series = [ sunData, windData ];

                $chart = new Chartist.Line('#graph', data, {
                    low: 0,
                    high: 4000
                });
            });
            // Socket.io
            var socket = io.connect('http://localhost:8080');
            socket.on('data', function (data) {
                if (data.city === cityName) {
                    sunData.push(data.sun);
                    windData.push(data.wind);

                    data.series = [ sunData, windData ];
                    $chart.update();
                }
            });
        </script>
    </body>
</html>
